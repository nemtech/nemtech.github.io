
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Integrating with an Exchange &#8212; Symbol Documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:400,400i,700&display=swap" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/examplecode.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Main',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/custom.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/examplecode.js"></script>
    <script type="text/javascript" src="https://unpkg.com/mermaid@7.1.0/dist/mermaid.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="REST API Troubleshooting Guide for Exchanges" href="exchange-REST-troubleshooting.html" />
    <link rel="prev" title="Exchanges" href="index.html" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=5'>
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174021413-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-174021413-2');
</script>

  
  <link rel="alternate" type="application/atom+xml"  href="../../guides/atom.xml" title="Blog">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body>

<div class="navbar navbar-default gradient navbar-fixed-top"
     id="navbar">
    <div class="container navbar-top hidden-xs hidden-sm">
        <div class="row">
            <div class="col-lg-8 col-md-7">
                <div id="language">
    <label class="select">
        <select>
            <option id="english" value="en">EN</option>
            <option id="japanese" value="ja">JA</option>
            <!--<option id="chinese" value="zh_CN">中文</option>-->
            <option id="translate" value="translate">Translate</option>
        </select>
    </label>
</div>
            </div>
            <div class="col-lg-4 col-md-5">
                
                <div id="search-box">
    <input class="search search-desktop form-control" placeholder="Search"/>
</div>
                
                <ul id="social" class="list-inline">
    <li>
        <a href="https://twitter.com/NEMofficial" rel="nofollow"><i class="fab fa-twitter" title="Twitter"></i></a>
    </li>
    <li>
        <a href="https://discord.com/invite/xymcity" rel="nofollow" title="Discord"><i class="fab fa-discord"></i></a>
    </li>
    <li>
        <a href="https://github.com/symbol/" rel="nofollow" title="GitHub"><i class="fab fa-github"></i></a>
    </li>
</ul>
            </div>
        </div>
    </div>
    <hr/>
    <div class="container navbar-main">
        <div class="row">
            <div class="navbar-header col-lg-6 col-md-4 col-xs-6">
                <a class="navbar-brand" href="../../index.html">
                    
                    <span><img alt="NEM logo" src="../../_static/logo-symbol.svg"></span>
                    
                </a>
            </div>
            <div class="navbar-right col-lg-6 col-md-8 hidden-xs hidden-sm">
                <ul class="list-inline">
    <li>
        <a href="/getting-started/what-is-symbol.html" class="">Getting Started</a>
    </li>
    <li>
        <a href="/concepts/overview.html" class="">Features</a>
    </li>
    <li>
        <a href="/guides/category.html" class="active">Guides</a>
    </li>
    <li>
        <a href="/references/overview.html" class="">Tools</a>
    </li>
    <li>
        <a href="/contribute/community.html" class="">Help</a>
    </li>
</ul>
            </div>
            <div class="navbar-right col-xs-6 hidden-lg hidden-md">
                
                <div id="search-box">
    <input class="search search-mobile form-control" placeholder="Search"/>
</div>
                

            </div>
        </div>
        <div class="row">
            <div class="col-md-12 sidebar-xs visible-xs visible-sm">
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Navigation <b
                            class="caret"></b></a>
                    <ul class="dropdown-menu globaltoc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../account/index.html">Accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aggregate/index.html">Aggregate transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blockchain/index.html">Blockchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../harvesting/index.html">Harvesting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/index.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migration/index.html">Migration from NIS1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitor/index.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mosaic/index.html">Mosaics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisig/index.html">Multisignature accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../namespace/index.html">Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restriction/index.html">Mosaic restrictions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secretlock/index.html">SecretLock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer/index.html">Transfers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Exchanges</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Integrating with an Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="exchange-REST-troubleshooting.html">REST API Troubleshooting Guide for Exchanges</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/overview.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/index.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributing</a></li>
</ul>
</ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        
        

<div class="col-md-3">
    <div id="sidebar" class="bs-sidenav" role="complementary">
        
        <div class="sidebar-md hidden-xs hidden-sm">
    <h4>Navigation</h4>
    <hr />
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../account/index.html">Accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aggregate/index.html">Aggregate transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blockchain/index.html">Blockchain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../harvesting/index.html">Harvesting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/index.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migration/index.html">Migration from NIS1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitor/index.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mosaic/index.html">Mosaics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisig/index.html">Multisignature accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../namespace/index.html">Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restriction/index.html">Mosaic restrictions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secretlock/index.html">SecretLock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer/index.html">Transfers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Exchanges</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Integrating with an Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="exchange-REST-troubleshooting.html">REST API Troubleshooting Guide for Exchanges</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/overview.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references/index.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributing</a></li>
</ul>

</div>
        
    </div>
</div>


        
        <div class="col-md-7 content">
            
  <div class="section" id="integrating-with-an-exchange">
<h1>Integrating with an Exchange<a class="headerlink" href="#integrating-with-an-exchange" title="Permalink to this headline">¶</a></h1>
<p>This document is intended to <strong>guide developers</strong> through the integration of the <code class="docutils literal"><span class="pre">XYM</span></code> token into an <strong>Exchange platform</strong>. It contains recommendations on how to set up accounts, listen for deposits, and create withdrawals as well as code examples ready to be adopted.</p>
<p>The code examples shared use the <a class="reference external" href="https://github.com/symbol/symbol-sdk-typescript-javascript">Symbol SDK for TypeScript</a>, but can be ported to other <a class="reference internal" href="../../sdk.html"><span class="doc">available SDKs</span></a> since all of them share the same design principles. If there is no SDK supported for a required programming language, you may still be able to integrate by connecting directly via Symbol’s <a class="reference internal" href="../../api.html"><span class="doc">REST API</span></a>.</p>
<div class="section" id="integration-overview">
<h2>Integration overview<a class="headerlink" href="#integration-overview" title="Permalink to this headline">¶</a></h2>
<p>There are many ways to design an exchange. This guide is based on how to support <code class="docutils literal"><span class="pre">XYM</span></code> deposits and withdrawals in an exchange that follows a <strong>central wallet approach</strong>.</p>
<p>Please note that this design is not particularly recommend over others. However, its <strong>simplified architecture</strong> is a good showcase for Symbol’s set of features involved in integrating with an Exchange. A different approach, for example, would be to use a different wallet for each user.</p>
<div class="figure align-center" id="id1">
<a class="reference external image-reference" href="/_images/exchange-integration-overview.png"><img alt="../../_images/exchange-integration-overview.png" src="../../_images/exchange-integration-overview.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Fig. 1</strong>: General design diagram of the central wallet approach.</span></p>
</div>
<p>The main components of this architecture are described next.</p>
<div class="section" id="components">
<h3>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h3>
<div class="section" id="central-wallet">
<h4>Central wallet<a class="headerlink" href="#central-wallet" title="Permalink to this headline">¶</a></h4>
<p>The exchange owns a Symbol account where all the user’s deposits and withdrawals occur. The keys to this account need to be on an online machine, so this is also commonly called the <strong>Hot</strong> wallet. This account only has the necessary amount of XYM for daily use (withdrawals and deposits), since it is the account most exposed to attacks.</p>
</div>
<div class="section" id="cold-wallet">
<h4>Cold wallet<a class="headerlink" href="#cold-wallet" title="Permalink to this headline">¶</a></h4>
<p>Cold wallet(s) hold a certain threshold for the pool of XYM. These accounts should be created and remain in a setup with no internet connection. Transactions issued from cold wallets must be signed offline and announced to the network using another device. It is advisable as well that cold wallets are set up with <a class="reference internal" href="../../concepts/multisig-account.html"><span class="doc">multisig accounts</span></a>.</p>
</div>
<div class="section" id="unique-user-id">
<h4>Unique User ID<a class="headerlink" href="#unique-user-id" title="Permalink to this headline">¶</a></h4>
<p>In the proposed architecture, each user is identified by a Unique User IDentifier (UUID) on the exchange’s database. A user will deposit to the central wallet with their UUID attached as the <a class="reference internal" href="../../concepts/transfer-transaction.html"><span class="doc">message</span></a> of the transaction (called sometimes the <strong>memo</strong>). The UUID is only shown in the user’s dashboard during the deposit confirmation.</p>
<p>One of the drawbacks of this design is that many users are not used to having a message attached to their transactions. If they forget to attach the UUID or attach a wrong UUID, it will lead to receiving lots of support tickets concerning “lost funds”.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>Symbol’s <a class="reference internal" href="../../concepts/transfer-transaction.html"><span class="doc">Transfer transactions</span></a> can hold an arbitrary message up to 1023 bytes long but <strong>the first byte is treated specially by the</strong> <a class="reference internal" href="../../sdk.html"><span class="doc">Symbol SDK</span></a>.</p>
<p>This can be a source of confusion because the receiver of a transaction does not know if the message was generated by the Symbol SDK or otherwise (for example accessing the <a class="reference internal" href="../../api.html"><span class="doc">REST gateway</span></a>), so it does not know if the first byte must be treated specially or not.</p>
<p>To avoid any issue, the following measures <strong>must always be enforced</strong>:</p>
<ul class="simple">
<li><strong>Always</strong> start messages with a byte in the 32 to 128 range (this is the standard ASCII printable range).</li>
<li><strong>Always</strong> ignore any received initial byte outside the 32 to 128 range.</li>
</ul>
<p class="last">Follow these rules, regardless of whether you use the Symbol SDK or not to generate and parse transfer transactions.</p>
</div>
</div>
<div class="section" id="exchange-server">
<h4>Exchange Server<a class="headerlink" href="#exchange-server" title="Permalink to this headline">¶</a></h4>
<p>This machine is constantly listening for user’s withdraw requests, and monitors the blockchain to detect user deposits into the Exchange Central Wallet. As explained in the rest of this document, it maintains the database updated and announces any required transaction.</p>
</div>
<div class="section" id="exchange-database">
<h4>Exchange Database<a class="headerlink" href="#exchange-database" title="Permalink to this headline">¶</a></h4>
<p>All the user’s funds are merged together in the Exchange’s wallets. This database keeps track of the amount of tokens each individual user holds. It also records all processed transactions, for record-keeping and to avoid processing the same transaction more than once.</p>
</div>
</div>
<div class="section" id="running-a-node">
<h3>Running a node<a class="headerlink" href="#running-a-node" title="Permalink to this headline">¶</a></h3>
<p>Although not absolutely necessary, it is <strong>recommended</strong> that Exchanges deploy <strong>their own Symbol node</strong> to communicate with the rest of the network. Since each node automatically connects to <strong>several other nodes</strong> on the network, this approach is more robust than accessing the network always through the same public node, which <strong>might become unavailable</strong>.</p>
<p>If you are unable to run your own node, you can connect to the ones managed by <strong>NEM Group</strong> so you know they are backed by a company and offer technical support. These nodes are identified by the word <code class="docutils literal"><span class="pre">ngl</span></code> in their URL, for instance:</p>
<ul class="simple">
<li><a class="reference external" href="http://ngl-dual-104.symbolblockchain.io:3000/node/info">ngl-dual-104.symbolblockchain.io</a>.</li>
</ul>
<p>See the <a class="reference internal" href="../network/index.html"><span class="doc">different guides about deploying Symbol nodes</span></a> and make sure you create an <a class="reference internal" href="../../concepts/node.html#api-node"><span class="std std-ref">API node</span></a>.</p>
</div>
<div class="section" id="accounts-setup">
<h3>Accounts setup<a class="headerlink" href="#accounts-setup" title="Permalink to this headline">¶</a></h3>
<p>Exchanges can create the central and cold wallets by <a class="reference internal" href="../../wallets.html"><span class="doc">downloading the official Symbol Desktop Wallet</span></a> for <strong>Windows</strong>, <strong>Linux</strong> or <strong>Mac</strong>.</p>
<p>Every wallet has assigned an <a class="reference internal" href="../../concepts/account.html"><span class="doc">account</span></a> (a deposit box that holds tokens, which can only be transferred with the appropriate private key).</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The <strong>private key must be kept secret at all times</strong> and must not be shared. Losing the private key means losing access to an account’s funds, so make sure it is <strong>securely backed up</strong>.</p>
</div>
<p>It is advisable to turn central and cold wallets into <a class="reference internal" href="../../concepts/multisig-account.html"><span class="doc">multisig accounts</span></a> to add <strong>two-factor authentication</strong>. The cosignatories of the multisig account become the account managers, so no transaction can be announced from the multisig account without the cosignatories’ approval. Symbol’s current implementation of multisig is <strong>“M-of-N”</strong> meaning that <em>M</em> out of the total <em>N</em> cosignatories of an account need to approve a transaction for it to be announced.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Multisig accounts are a <strong>powerful</strong> yet <strong>dangerous</strong> tool. If access to some cosignatory account is lost and the minimum approval is not reached (the <em>M</em> above), access to the multisig account can be permanently lost. <strong>Always configure multisig accounts with caution</strong>.</p>
</div>
<p>To strengthen security, <a class="reference internal" href="../../concepts/account-restriction.html"><span class="doc">extra account restrictions</span></a> can be added to the Exchange’s accounts, like blocking announcing or receiving transactions given a series of rules.</p>
<div class="topic">
<p class="topic-title first">Related links</p>
<ul class="simple">
<li><a class="reference internal" href="../../wallets.html"><span class="doc">Download the Symbol client</span></a>.</li>
<li><a class="reference internal" href="../account/creating-an-account.html"><span class="doc">How to create a new account</span></a>.</li>
<li><a class="reference internal" href="../multisig/creating-a-multisig-account.html"><span class="doc">How to turn an account into a multisig account</span></a>.</li>
<li><a class="reference internal" href="../restriction/preventing-spam-attacks-with-account-restrictions.html"><span class="doc">How to set account restrictions</span></a>.</li>
</ul>
</div>
</div>
<div class="section" id="the-xym-token">
<h3>The XYM token<a class="headerlink" href="#the-xym-token" title="Permalink to this headline">¶</a></h3>
<p>The native currency of the Symbol network is named <code class="docutils literal"><span class="pre">XYM</span></code>. The token is used to pay for transactions and service <a class="reference internal" href="../../concepts/fees.html"><span class="doc">fees</span></a>, which are used as well to provide an incentive for those <a class="reference internal" href="../../concepts/harvesting.html"><span class="doc">participants</span></a> who secure the network and run the infrastructure.</p>
<p>Tokens can be divided up to <code class="docutils literal"><span class="pre">divisibility</span></code> decimal places. Amounts given without decimals are called <strong>absolute</strong>, whereas when decimals are used amounts are called <strong>relative</strong>. For example, when divisibility is 6, 1 relative token corresponds to 1‘000‘000 absolute tokens, and the smallest token is 0.000001 relative units. The smallest absolute unit is always 1, regardless of the divisibility.</p>
<p>These are the properties of <code class="docutils literal"><span class="pre">XYM</span></code>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="25%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property</th>
<th class="head">Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ID</td>
<td><code class="docutils literal"><span class="pre">0x6BED913FA20223F8</span></code></td>
<td>Token unique identifier</td>
</tr>
<tr class="row-odd"><td>Alias</td>
<td><code class="docutils literal"><span class="pre">symbol.xym</span></code></td>
<td>Friendly name for the token</td>
</tr>
<tr class="row-even"><td>Initial supply</td>
<td>7‘842‘928‘625 (relative)</td>
<td>Initial amount of token units in circulation</td>
</tr>
<tr class="row-odd"><td>Max supply</td>
<td>8‘999‘999‘999 (relative)</td>
<td>Maximum amount of token units in circulation after <a class="reference internal" href="../../concepts/inflation.html"><span class="doc">inflation</span></a> is applied</td>
</tr>
<tr class="row-even"><td>Divisibility</td>
<td>6</td>
<td>This means that the smallest fraction of the token is 0.000001 (relative).</td>
</tr>
<tr class="row-odd"><td>Duration</td>
<td>0</td>
<td>Token does not expire</td>
</tr>
<tr class="row-even"><td>Supply mutable</td>
<td>False</td>
<td>Token supply cannot be altered</td>
</tr>
<tr class="row-odd"><td>Transferable</td>
<td>True</td>
<td>Token can be transferred between arbitrary accounts</td>
</tr>
<tr class="row-even"><td>Restrictable</td>
<td>False</td>
<td>Token creator cannot restrict which accounts can transact with the mosaic</td>
</tr>
</tbody>
</table>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>The <code class="docutils literal"><span class="pre">XYM</span></code> token can be referred to through its <strong>native token ID</strong> or its <strong>friendlier alias</strong> <code class="docutils literal"><span class="pre">symbol.xym</span></code>, which has an ID on itself.</p>
<p>On MAINNET, these IDs are <code class="docutils literal"><span class="pre">0x6BED913FA20223F8</span></code> (mosaic ID) and <code class="docutils literal"><span class="pre">0xE74B99BA41F4AFEE</span></code> (alias ID).</p>
<p class="last"><strong>Always treat these two IDs as equivalent.</strong></p>
</div>
</div>
<div class="section" id="avoiding-rollbacks">
<span id="exchange-avoid-rollbacks"></span><h3>Avoiding rollbacks<a class="headerlink" href="#avoiding-rollbacks" title="Permalink to this headline">¶</a></h3>
<p>This is a <strong>classic conflict</strong> in blockchain technology: On one hand, if transactions are accepted too quickly, they might need to be <strong>reverted</strong> later on in the event of a <a class="reference internal" href="../../concepts/block.html#rollbacks"><span class="std std-ref">network fork</span></a>. On the other hand, waiting for too long is <strong>inconvenient</strong> for users.</p>
<p>There are two ways of dealing with this in Symbol:</p>
<div class="section" id="using-finalization">
<h4>Using Finalization<a class="headerlink" href="#using-finalization" title="Permalink to this headline">¶</a></h4>
<p>Symbol implements <a class="reference internal" href="../../concepts/block.html#finalization"><span class="std std-ref">Finalization</span></a>, a process that <strong>guarantees</strong> that blocks are <strong>immutable</strong> and therefore transactions are secure.</p>
<p>To know if a block has been finalized, check the <code class="docutils literal"><span class="pre">latestFinalizedBlock</span></code> property in the <a class="reference external" href="https://docs.symbolplatform.com/symbol-openapi/v1.0.1/#operation/getChainInfo">/chain/info</a> endpoint. All blocks with a <strong>height</strong> lower than (or equal to) <code class="docutils literal"><span class="pre">latestFinalizedBlock.height</span></code> are <strong>finalized</strong> and are therefore <strong>immutable</strong>. <a class="reference external" href="http://ngl-dual-104.symbolblockchain.io:3000/chain/info">See here for a real-time MAINNET example</a>.</p>
<p><strong>On average</strong>, blocks are finalized after 5 minutes, in the absence of network problems.</p>
</div>
<div class="section" id="using-a-fixed-wait">
<h4>Using a fixed wait<a class="headerlink" href="#using-a-fixed-wait" title="Permalink to this headline">¶</a></h4>
<p>To have faster response times, one must ignore finalization and <strong>accept the risk</strong> that comes with this: <strong>Unfinalized blocks have a probability of being reverted</strong>, which decreases over time but is never zero until the block is finalized.</p>
<p>The procedure, which is common in blockchains which do not support finalization, is to <strong>wait for a few blocks</strong> to be validated (added to the blockchain) before accepting a transaction.</p>
<p>The amount of blocks to wait for depends on the risk one wants to accept. The recommendation for Symbol is <strong>20 blocks</strong> (about 10 minutes, regardless of network conditions, because Finalization will almost always happen during this time).</p>
<div class="topic">
<p class="topic-title first">In summary</p>
<ul class="simple">
<li>Waiting for a <strong>fixed amount</strong> of blocks leads to consistent confirmation times, but has the risk that confirmed transactions might be <strong>reverted</strong>.</li>
<li>Waiting for <strong>finalization</strong> has variable confirmation times (5 minutes on average) but has <strong>zero rollback risk</strong>.</li>
</ul>
</div>
</div>
<div class="section" id="deadlines">
<h4>Deadlines<a class="headerlink" href="#deadlines" title="Permalink to this headline">¶</a></h4>
<p>An added problem caused by rollbacks is that <strong>transactions might expire</strong> in the process of resolving a network fork.</p>
<p>A bit of context is required here. Transactions are not allowed to remain unconfirmed in the network forever, as this would pose a significant strain on the network’s resources. Instead, <strong>all transactions have a deadline</strong>, and are automatically disposed of when the deadline arrives.</p>
<p>Users are free to use any deadline they want for their transactions, between now and 6h into the future (48h for <a class="reference internal" href="../../concepts/aggregate-transaction.html#aggregate-bonded"><span class="std std-ref">Aggregate bonded</span></a> transactions).</p>
<p>Transactions which are about to expire are delicate because, even if they get confirmed and are added to the blockchain, <strong>a rollback could send them back to the unconfirmed state</strong> and their deadline could expire before they are confirmed again.</p>
<div class="topic">
<p class="topic-title first">Therefore, it is recommended that:</p>
<ul>
<li><p class="first">Incoming transactions with a deadline <strong>less than 1h into the future</strong> are rejected with a warning message, for example:</p>
<p><code class="docutils literal"><span class="pre">Transaction</span> <span class="pre">is</span> <span class="pre">too</span> <span class="pre">close</span> <span class="pre">to</span> <span class="pre">expiration</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">safely</span> <span class="pre">accepted.</span></code></p>
</li>
<li><p class="first">Exchanges avoid using transactions with short lifespans.</p>
</li>
<li><p class="first">Exchanges actively encourage their customers to avoid using transactions with short lifespans.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="the-example-code">
<h3>The example code<a class="headerlink" href="#the-example-code" title="Permalink to this headline">¶</a></h3>
<p>This guide shows snippets of code to exemplify the different processes. All snippets are based on the same program that <a class="reference external" href="https://github.com/symbol/symbol-docs/tree/main/source/resources/examples/typescript/exchanges">can be found here</a>. A few notes on this example program:</p>
<ul class="simple">
<li>It uses a fake <code class="docutils literal"><span class="pre">DBService</span></code> object that simulates the Exchange database. Calls to this object should obviously be replaced by the actual Exchange infrastructure in production code. For simplicity these calls are synchronous but they could be made asynchronously too.</li>
<li>No error handling is performed at all. Use mechanisms like <code class="docutils literal"><span class="pre">try</span> <span class="pre">{}</span> <span class="pre">catch</span></code> where appropriate in production code.</li>
<li>Finally, besides the snippets shown in the guide, the complete program also contains auxiliary code (like polling loops) in order to make it runnable and self-sufficient. This auxiliary code is not meant to be used as an inspiration at all, it is just there for convenience.</li>
</ul>
</div>
</div>
<div class="section" id="deposits">
<span id="exchange-deposits"></span><h2>Deposits<a class="headerlink" href="#deposits" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id2">
<a class="reference external image-reference" href="/_images/exchange-integration-deposit.png"><img alt="../../_images/exchange-integration-deposit.png" src="../../_images/exchange-integration-deposit.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Fig. 2</strong>: Deposit process.</span></p>
</div>
<p>Users perform deposits by announcing a regular transfer transaction using their wallet, moving the funds from their account directly to the Exchange Central Wallet. Since the transfer is handled entirely by the blockchain, the funds will be added to the Exchange Central Wallet without the Exchange’s mediation, and this poses some problems:</p>
<ul class="simple">
<li>The <strong>intended recipient</strong> of the transaction must be determined. This is done by attaching the user’s UUID as the transaction’s message.</li>
<li>The fact that a transaction has happened must be timely detected to update the user’s account on the Exchange.</li>
<li>Transactions must be <strong>finalized</strong> to be 100% sure that they will not be <a class="reference internal" href="../../concepts/block.html#rollbacks"><span class="std std-ref">rolled back</span></a>.</li>
</ul>
<p>The code proposed next addresses all these issues by monitoring the blockchain.</p>
<div class="section" id="monitoring">
<h3>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h3>
<p>The blockchain is polled periodically and all incoming transactions since last poll are processed in a batch:</p>
<ol class="arabic">
<li><p class="first">All transactions added to the blockchain <strong>since</strong> the last check and <strong>up to</strong> the latest finalized block are examined, looking for the ones destined to the Central Exchange Wallet. This can be done efficiently with a single Symbol API call.</p>
<p>If Finalization is not desired (see the <a class="reference internal" href="#exchange-avoid-rollbacks"><span class="std std-ref">Avoiding rollbacks</span></a> section above) you can search up to 20 blocks before the current chain height, for example.</p>
</li>
<li><p class="first">Filter out transactions that:</p>
<ol class="loweralpha simple">
<li>Have no message or the message does not correspond to an existing UUID.</li>
<li>Do not contain tokens, or the token is not <code class="docutils literal"><span class="pre">symbol.xym</span></code>.</li>
<li>Have already been processed (as a security measure).</li>
</ol>
</li>
<li><p class="first">The remaining transactions are then processed:</p>
<ol class="loweralpha simple">
<li>The tokens are added to the user’s account in the database.</li>
<li>The transaction is marked as processed by adding its hash to the database</li>
</ol>
</li>
<li><p class="first">Store the last height that has been processed and wait for the next polling period.</p>
</li>
</ol>
<p>The code snippet, using <a class="reference external" href="https://docs.symbolplatform.com/symbol-sdk-typescript-javascript/1.0.0/">Symbol’s TypeScript SDK</a> is this:</p>
<div class="example-code container">
<div class="literal-block-wrapper container" id="id3">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/ProcessDeposits.ts">View Code</a></span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-typescript"><div class="highlight"><pre><span></span>  <span class="c1">// Mocks a database service</span>
  <span class="kd">const</span> <span class="nx">dbService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DBServiceImpl</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">config</span>: <span class="kt">ExchangeSymbolConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Replace with your node URL</span>
    <span class="nx">apiUrl</span><span class="o">:</span> <span class="s1">&#39;http://ngl-dual-101.testnet.symboldev.network:3000&#39;</span><span class="p">,</span>
    <span class="c1">// Use MAIN_NET or TEST_NET</span>
    <span class="nx">networkType</span>: <span class="kt">NetworkType.TEST_NET</span><span class="p">,</span>
    <span class="c1">// Replace with value from http://&lt;API-NODE-URL&gt;:3000/network/properties</span>
    <span class="nx">networkGenerationHashSeed</span><span class="o">:</span>
      <span class="s1">&#39;3B5E1FA6445653C971A50687E75E6D09FB30481055E3990C84B25E9222DC1155&#39;</span><span class="p">,</span>
    <span class="c1">// Replace with the account central address</span>
    <span class="nx">centralAccountAddress</span>: <span class="kt">Address.createFromRawAddress</span><span class="p">(</span>
      <span class="s1">&#39;TAOXUJOTTW3W5XTBQMQEX3SQNA6MCUVGXLXR3TA&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="c1">// Use 6BED913FA20223F8 for MAIN_NET or 091F837E059AE13C for TEST_NET</span>
    <span class="nx">tokenId</span>: <span class="kt">new</span> <span class="nx">MosaicId</span><span class="p">(</span><span class="s1">&#39;091F837E059AE13C&#39;</span><span class="p">),</span>
    <span class="nx">tokenAlias</span>: <span class="kt">new</span> <span class="nx">NamespaceId</span><span class="p">(</span><span class="s1">&#39;symbol.xym&#39;</span><span class="p">),</span>
    <span class="nx">tokenDivisibility</span>: <span class="kt">6</span><span class="p">,</span>
    <span class="nx">requiredConfirmations</span>: <span class="kt">20</span><span class="p">,</span>
    <span class="nx">useFinalization</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">repositoryFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RepositoryFactoryHttp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">chainHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createChainRepository</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">transactionHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createTransactionRepository</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">transactionPaginationStreamer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionPaginationStreamer</span><span class="p">(</span>
    <span class="nx">transactionHttp</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="c1">// Get current chain height and latest finalized block</span>
  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">height</span>: <span class="kt">currentHeight</span><span class="p">,</span>
    <span class="nx">latestFinalizedBlock</span>: <span class="kt">finalizationBlock</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">chainHttp</span><span class="p">.</span><span class="nx">getChainInfo</span><span class="p">().</span><span class="nx">toPromise</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">useFinalization</span>
    <span class="o">?</span> <span class="nx">finalizationBlock.height</span>
    : <span class="kt">currentHeight.subtract</span><span class="p">(</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">requiredConfirmations</span><span class="p">));</span>

  <span class="c1">// 1. Look for confirmed transactions destined to the central account address,</span>
  <span class="c1">// in the desired block height range.</span>
  <span class="kd">const</span> <span class="nx">searchCriteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">group</span>: <span class="kt">TransactionGroup.Confirmed</span><span class="p">,</span>
    <span class="nx">recipientAddress</span>: <span class="kt">config.centralAccountAddress</span><span class="p">,</span>
    <span class="nx">embedded</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">order</span>: <span class="kt">Order.Asc</span><span class="p">,</span>
    <span class="kd">type</span><span class="o">:</span> <span class="p">[</span><span class="nx">TransactionType</span><span class="p">.</span><span class="nx">TRANSFER</span><span class="p">],</span>
    <span class="nx">fromHeight</span>: <span class="kt">dbService.getLastProcessedHeight</span><span class="p">(),</span>
    <span class="nx">toHeight</span>: <span class="kt">maxHeight</span><span class="p">,</span>
  <span class="p">}</span> <span class="kr">as</span> <span class="nx">TransactionSearchCriteria</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionPaginationStreamer</span>
    <span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">searchCriteria</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">toArray</span><span class="p">()</span> <span class="kr">as</span> <span class="nx">any</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>

  <span class="c1">// 2. Exclude invalid transactions</span>
  <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span> <span class="kr">as</span> <span class="nx">TransferTransaction</span><span class="p">[]).</span><span class="nx">filter</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">transactionIndex</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span>
      <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">AggregateTransactionInfo</span>
        <span class="o">?</span> <span class="nx">transactionInfo.aggregateHash</span>
        : <span class="kt">transactionInfo.hash</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="c1">// 2.a</span>
      <span class="nx">dbService</span><span class="p">.</span><span class="nx">existsUser</span><span class="p">(</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// 2.b</span>
      <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mf">1</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">===</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">||</span>
        <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">===</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenAlias</span><span class="p">.</span><span class="nx">toHex</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// 2.c</span>
      <span class="o">!</span><span class="nx">dbService</span><span class="p">.</span><span class="nx">existsTransaction</span><span class="p">(</span><span class="nx">transactionHash</span><span class="p">,</span> <span class="nx">transactionIndex</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// 3. Record the valid deposits in the exchange database</span>
  <span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span>
      <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">AggregateTransactionInfo</span>
        <span class="o">?</span> <span class="nx">transactionInfo.aggregateHash</span>
        : <span class="kt">transactionInfo.hash</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">transactionIndex</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">amount</span> <span class="o">=</span>
      <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">amount</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span> <span class="o">/</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
    <span class="nx">dbService</span><span class="p">.</span><span class="nx">recordDeposit</span><span class="p">(</span>
      <span class="nx">transaction</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">,</span>
      <span class="nx">amount</span><span class="p">,</span>
      <span class="nx">transactionHash</span><span class="p">,</span>
      <span class="nx">transactionIndex</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// 4. Store the last height that has been processed</span>
  <span class="nx">dbService</span><span class="p">.</span><span class="nx">setLastProcessedHeight</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id4">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/ProcessDeposits.js">View Code</a></span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>    <span class="c1">// Mocks a database service</span>
    <span class="kd">const</span> <span class="nx">dbService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DBServiceImpl_1</span><span class="p">.</span><span class="nx">DBServiceImpl</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// Replace with your node URL</span>
        <span class="nx">apiUrl</span><span class="o">:</span> <span class="s1">&#39;http://ngl-dual-101.testnet.symboldev.network:3000&#39;</span><span class="p">,</span>
        <span class="c1">// Use MAIN_NET or TEST_NET</span>
        <span class="nx">networkType</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">NetworkType</span><span class="p">.</span><span class="nx">TEST_NET</span><span class="p">,</span>
        <span class="c1">// Replace with value from http://&lt;API-NODE-URL&gt;:3000/network/properties</span>
        <span class="nx">networkGenerationHashSeed</span><span class="o">:</span> <span class="s1">&#39;3B5E1FA6445653C971A50687E75E6D09FB30481055E3990C84B25E9222DC1155&#39;</span><span class="p">,</span>
        <span class="c1">// Replace with the account central address</span>
        <span class="nx">centralAccountAddress</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Address</span><span class="p">.</span><span class="nx">createFromRawAddress</span><span class="p">(</span><span class="s1">&#39;TAOXUJOTTW3W5XTBQMQEX3SQNA6MCUVGXLXR3TA&#39;</span><span class="p">),</span>
        <span class="c1">// Use 6BED913FA20223F8 for MAIN_NET or 091F837E059AE13C for TEST_NET</span>
        <span class="nx">tokenId</span><span class="o">:</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">MosaicId</span><span class="p">(</span><span class="s1">&#39;091F837E059AE13C&#39;</span><span class="p">),</span>
        <span class="nx">tokenAlias</span><span class="o">:</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">NamespaceId</span><span class="p">(</span><span class="s1">&#39;symbol.xym&#39;</span><span class="p">),</span>
        <span class="nx">tokenDivisibility</span><span class="o">:</span> <span class="mf">6</span><span class="p">,</span>
        <span class="nx">requiredConfirmations</span><span class="o">:</span> <span class="mf">20</span><span class="p">,</span>
        <span class="nx">useFinalization</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">repositoryFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">RepositoryFactoryHttp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">chainHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createChainRepository</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">transactionHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createTransactionRepository</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">transactionPaginationStreamer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionPaginationStreamer</span><span class="p">(</span><span class="nx">transactionHttp</span><span class="p">);</span>
    <span class="c1">// Get current chain height and latest finalized block</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">latestFinalizedBlock</span><span class="o">:</span> <span class="nx">finalizationBlock</span><span class="p">,</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">chainHttp</span><span class="p">.</span><span class="nx">getChainInfo</span><span class="p">().</span><span class="nx">toPromise</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">useFinalization</span>
        <span class="o">?</span> <span class="nx">finalizationBlock</span><span class="p">.</span><span class="nx">height</span>
        <span class="o">:</span> <span class="nx">currentHeight</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">requiredConfirmations</span><span class="p">));</span>
    <span class="c1">// 1. Look for confirmed transactions destined to the central account address,</span>
    <span class="c1">// in the desired block height range.</span>
    <span class="kd">const</span> <span class="nx">searchCriteria</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">group</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionGroup</span><span class="p">.</span><span class="nx">Confirmed</span><span class="p">,</span>
        <span class="nx">recipientAddress</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">centralAccountAddress</span><span class="p">,</span>
        <span class="nx">embedded</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">order</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Order</span><span class="p">.</span><span class="nx">Asc</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="p">[</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionType</span><span class="p">.</span><span class="nx">TRANSFER</span><span class="p">],</span>
        <span class="nx">fromHeight</span><span class="o">:</span> <span class="nx">dbService</span><span class="p">.</span><span class="nx">getLastProcessedHeight</span><span class="p">(),</span>
        <span class="nx">toHeight</span><span class="o">:</span> <span class="nx">maxHeight</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionPaginationStreamer</span>
        <span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">searchCriteria</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">operators_1</span><span class="p">.</span><span class="nx">toArray</span><span class="p">())</span>
        <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>
    <span class="c1">// 2. Exclude invalid transactions</span>
    <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_a</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionIndex</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span> <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">AggregateTransactionInfo</span>
            <span class="o">?</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">aggregateHash</span>
            <span class="o">:</span> <span class="p">(</span><span class="nx">_a</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">_a</span> <span class="o">!==</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="nx">_a</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">(</span>
        <span class="c1">// 2.a</span>
        <span class="nx">dbService</span><span class="p">.</span><span class="nx">existsUser</span><span class="p">(</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="c1">// 2.b</span>
            <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mf">1</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">===</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">||</span>
                <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">toHex</span><span class="p">()</span> <span class="o">===</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenAlias</span><span class="p">.</span><span class="nx">toHex</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
            <span class="c1">// 2.c</span>
            <span class="o">!</span><span class="nx">dbService</span><span class="p">.</span><span class="nx">existsTransaction</span><span class="p">(</span><span class="nx">transactionHash</span><span class="p">,</span> <span class="nx">transactionIndex</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="c1">// 3. Record the valid deposits in the exchange database</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_a</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span> <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">AggregateTransactionInfo</span>
            <span class="o">?</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">aggregateHash</span>
            <span class="o">:</span> <span class="p">(</span><span class="nx">_a</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">_a</span> <span class="o">!==</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="nx">_a</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">transactionIndex</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">amount</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span> <span class="o">/</span>
            <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
        <span class="nx">dbService</span><span class="p">.</span><span class="nx">recordDeposit</span><span class="p">(</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">transactionHash</span><span class="p">,</span> <span class="nx">transactionIndex</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">// 4. Store the last height that has been processed</span>
    <span class="nx">dbService</span><span class="p">.</span><span class="nx">setLastProcessedHeight</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>All configuration data is held in the <code class="docutils literal"><span class="pre">ExchangeSymbolConfig</span></code> object including the selection of the finalization mechanism.</p>
<p>The above code snippet should be called <strong>in a loop</strong> every minute, for example, and it will process <strong>all new valid transactions</strong> that have already been finalized (or that have waited enough blocks, depending on the chosen method).</p>
<p>However, <strong>transactions will not be reported immediately</strong>, and this might be annoying for users. Using <a class="reference internal" href="../../api.html#websockets"><span class="std std-ref">WebSockets</span></a> transactions can be monitored in real-time and a notification can be shown to the user as soon as a transaction is <strong>confirmed</strong> on the network (or even as soon as it is <strong>announced</strong> on the network).</p>
<p>These transactions, though, should be clearly marked as <strong>pending</strong> and <strong>not acted upon</strong> until verified by the above code, to <a class="reference internal" href="#exchange-avoid-rollbacks"><span class="std std-ref">avoid rollbacks</span></a>.</p>
<div class="topic">
<p class="topic-title first">Related links</p>
<ul class="simple">
<li><a class="reference internal" href="../../concepts/transfer-transaction.html"><span class="doc">Transfer Transaction reference</span></a>.</li>
<li><a class="reference internal" href="../../concepts/mosaic.html"><span class="doc">Mosaic (token) reference</span></a>.</li>
<li><a class="reference internal" href="../../api.html"><span class="doc">Symbol API reference</span></a>.</li>
<li><a class="reference internal" href="../../api.html#websockets"><span class="std std-ref">WebSockets reference</span></a>.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="withdrawals">
<span id="exchange-withdrawals"></span><h2>Withdrawals<a class="headerlink" href="#withdrawals" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id5">
<a class="reference external image-reference" href="/_images/exchange-integration-withdrawal.png"><img alt="../../_images/exchange-integration-withdrawal.png" src="../../_images/exchange-integration-withdrawal.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text"><strong>Fig. 3</strong>: Withdrawal process.</span></p>
</div>
<p>Users send withdrawal requests to the Exchange Server, via a web page or mobile app, for example. If the database indicates that the user has enough funds to perform the withdrawal, a <a class="reference internal" href="../../concepts/transfer-transaction.html"><span class="doc">transfer transaction</span></a> is announced from the Exchange Central Wallet to the Symbol address indicated in the request.</p>
<p>Announcing the transaction has a <a class="reference internal" href="../../concepts/fees.html"><span class="doc">fee</span></a>, which is paid by the Exchange Central Wallet but can be deduced from the user’s account. Regardless of the token being transferred, fees are always paid in XYM tokens.</p>
<p>The withdrawal process requires two steps: First the transaction transferring the funds is <strong>announced</strong> and confirmed (added to the blockchain). Afterwards, the exchange needs to wait for the transaction to be <strong>finalized</strong>, as explained in the <a class="reference internal" href="#exchange-avoid-rollbacks"><span class="std std-ref">Avoiding rollbacks</span></a> section above.</p>
<div class="section" id="announcing">
<h3>Announcing<a class="headerlink" href="#announcing" title="Permalink to this headline">¶</a></h3>
<p>The withdrawal transaction is just a regular Symbol <a class="reference internal" href="../../concepts/transfer-transaction.html"><span class="doc">transfer transaction</span></a>. The code looks long because it contains a lot of repeated boilerplate, to make it self-contained:</p>
<ul class="simple">
<li>Configuration is stored in the <code class="docutils literal"><span class="pre">ExchangeSymbolConfig</span></code> object.</li>
<li>A number of repositories are instantiated via the <code class="docutils literal"><span class="pre">RepositoryFactoryHttp</span></code> class.</li>
<li>The withdrawal details are retrieved from environment variables in this example.</li>
</ul>
<p>Then:</p>
<ol class="arabic simple">
<li>The actual transaction is created using <code class="docutils literal"><span class="pre">TransferTransaction.create</span></code>.</li>
<li>The transaction is signed.</li>
<li>The signed transaction is announced using the <code class="docutils literal"><span class="pre">TransactionService</span></code> to simplify waiting for its confirmation.</li>
</ol>
<div class="example-code container">
<div class="literal-block-wrapper container" id="id6">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/SendWithdrawal.ts">View Code</a></span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-typescript"><div class="highlight"><pre><span></span>  <span class="c1">// Mocks a database service</span>
  <span class="kd">const</span> <span class="nx">dbService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DBServiceImpl</span><span class="p">();</span>

  <span class="c1">// Exchange configuration</span>
  <span class="kd">const</span> <span class="nx">config</span>: <span class="kt">ExchangeSymbolConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Replace with your node URL</span>
    <span class="nx">apiUrl</span><span class="o">:</span> <span class="s1">&#39;http://ngl-dual-101.testnet.symboldev.network:3000&#39;</span><span class="p">,</span>
    <span class="c1">// Use MAIN_NET or TEST_NET</span>
    <span class="nx">networkType</span>: <span class="kt">NetworkType.TEST_NET</span><span class="p">,</span>
    <span class="c1">// Replace with value from http://&lt;API-NODE-URL&gt;:3000/network/properties</span>
    <span class="nx">networkGenerationHashSeed</span><span class="o">:</span>
      <span class="s1">&#39;3B5E1FA6445653C971A50687E75E6D09FB30481055E3990C84B25E9222DC1155&#39;</span><span class="p">,</span>
    <span class="c1">// Replace with the account central address</span>
    <span class="nx">centralAccountAddress</span>: <span class="kt">Address.createFromRawAddress</span><span class="p">(</span>
      <span class="s1">&#39;TAOXUJOTTW3W5XTBQMQEX3SQNA6MCUVGXLXR3TA&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="c1">// Use 6BED913FA20223F8 for MAIN_NET or 091F837E059AE13C for TEST_NET</span>
    <span class="nx">tokenId</span>: <span class="kt">new</span> <span class="nx">MosaicId</span><span class="p">(</span><span class="s1">&#39;091F837E059AE13C&#39;</span><span class="p">),</span>
    <span class="nx">tokenAlias</span>: <span class="kt">new</span> <span class="nx">NamespaceId</span><span class="p">(</span><span class="s1">&#39;symbol.xym&#39;</span><span class="p">),</span>
    <span class="nx">tokenDivisibility</span>: <span class="kt">6</span><span class="p">,</span>
    <span class="nx">requiredConfirmations</span>: <span class="kt">20</span><span class="p">,</span>
    <span class="nx">useFinalization</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="c1">// Repositories</span>
  <span class="kd">const</span> <span class="nx">repositoryFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RepositoryFactoryHttp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createListener</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">transactionHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createTransactionRepository</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">chainHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createChainRepository</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">transactionService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionService</span><span class="p">(</span>
    <span class="nx">transactionHttp</span><span class="p">,</span>
    <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createReceiptRepository</span><span class="p">(),</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">transactionPaginationStreamer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionPaginationStreamer</span><span class="p">(</span>
    <span class="nx">transactionHttp</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="c1">// Replace with exchange account private key</span>
  <span class="kd">const</span> <span class="nx">exchangeAccountPrivateKey</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PRIVATE_KEY</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">exchangeAccount</span> <span class="o">=</span> <span class="nx">Account</span><span class="p">.</span><span class="nx">createFromPrivateKey</span><span class="p">(</span>
    <span class="nx">exchangeAccountPrivateKey</span><span class="p">,</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">networkType</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="c1">// Replace with destination address from user&#39;s request</span>
  <span class="kd">const</span> <span class="nx">userRawAddress</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RECIPIENT_ADDRESS</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">userAddress</span> <span class="o">=</span> <span class="nx">Address</span><span class="p">.</span><span class="nx">createFromRawAddress</span><span class="p">(</span><span class="nx">userRawAddress</span><span class="p">);</span>
  <span class="c1">// Replace with the source UUID from user&#39;s request</span>
  <span class="kd">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">UUID</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">;</span>
  <span class="c1">// Replace with amount of tokens to transfer from user&#39;s request</span>
  <span class="kd">const</span> <span class="nx">relativeAmount</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AMOUNT</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">);</span>

  <span class="c1">// Check that the user has enough funds</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">dbService</span><span class="p">.</span><span class="nx">getUserAmount</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">relativeAmount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;User &#39;</span> <span class="o">+</span> <span class="nx">uuid</span> <span class="o">+</span> <span class="s1">&#39; does not have enough funds.&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 1. Create withdrawal transaction</span>
  <span class="kd">const</span> <span class="nx">absoluteAmount</span> <span class="o">=</span>
    <span class="nx">relativeAmount</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mosaic</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">absoluteAmount</span><span class="p">));</span>

  <span class="kd">const</span> <span class="nx">epochAdjustment</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repositoryFactory</span>
    <span class="p">.</span><span class="nx">getEpochAdjustment</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">withdrawalTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
    <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">epochAdjustment</span><span class="p">),</span>
    <span class="nx">userAddress</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">token</span><span class="p">],</span>
    <span class="nx">EmptyMessage</span><span class="p">,</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">networkType</span><span class="p">,</span>
    <span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mf">200000</span><span class="p">),</span> <span class="c1">// Fixed max fee of 0.2 XYM</span>
  <span class="p">);</span>

  <span class="c1">// 2. Sign transaction</span>
  <span class="kd">const</span> <span class="nx">signedTransaction</span> <span class="o">=</span> <span class="nx">exchangeAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
    <span class="nx">withdrawalTransaction</span><span class="p">,</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">networkGenerationHashSeed</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="c1">// 3. Announce transaction and wait for confirmation</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Announcing transaction&#39;</span><span class="p">,</span> <span class="nx">signedTransaction</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionService</span>
    <span class="p">.</span><span class="nx">announce</span><span class="p">(</span><span class="nx">signedTransaction</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s1">&#39;Transaction confirmed at height&#39;</span><span class="p">,</span>
    <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="o">?</span><span class="p">.</span><span class="nx">height</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span> <span class="o">??</span> <span class="mf">0</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="nx">listener</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id7">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/SendWithdrawal.js">View Code</a></span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>    <span class="c1">// Mocks a database service</span>
    <span class="kd">const</span> <span class="nx">dbService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DBServiceImpl_1</span><span class="p">.</span><span class="nx">DBServiceImpl</span><span class="p">();</span>
    <span class="c1">// Exchange configuration</span>
    <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// Replace with your node URL</span>
        <span class="nx">apiUrl</span><span class="o">:</span> <span class="s1">&#39;http://ngl-dual-101.testnet.symboldev.network:3000&#39;</span><span class="p">,</span>
        <span class="c1">// Use MAIN_NET or TEST_NET</span>
        <span class="nx">networkType</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">NetworkType</span><span class="p">.</span><span class="nx">TEST_NET</span><span class="p">,</span>
        <span class="c1">// Replace with value from http://&lt;API-NODE-URL&gt;:3000/network/properties</span>
        <span class="nx">networkGenerationHashSeed</span><span class="o">:</span> <span class="s1">&#39;3B5E1FA6445653C971A50687E75E6D09FB30481055E3990C84B25E9222DC1155&#39;</span><span class="p">,</span>
        <span class="c1">// Replace with the account central address</span>
        <span class="nx">centralAccountAddress</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Address</span><span class="p">.</span><span class="nx">createFromRawAddress</span><span class="p">(</span><span class="s1">&#39;TAOXUJOTTW3W5XTBQMQEX3SQNA6MCUVGXLXR3TA&#39;</span><span class="p">),</span>
        <span class="c1">// Use 6BED913FA20223F8 for MAIN_NET or 091F837E059AE13C for TEST_NET</span>
        <span class="nx">tokenId</span><span class="o">:</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">MosaicId</span><span class="p">(</span><span class="s1">&#39;091F837E059AE13C&#39;</span><span class="p">),</span>
        <span class="nx">tokenAlias</span><span class="o">:</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">NamespaceId</span><span class="p">(</span><span class="s1">&#39;symbol.xym&#39;</span><span class="p">),</span>
        <span class="nx">tokenDivisibility</span><span class="o">:</span> <span class="mf">6</span><span class="p">,</span>
        <span class="nx">requiredConfirmations</span><span class="o">:</span> <span class="mf">20</span><span class="p">,</span>
        <span class="nx">useFinalization</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="c1">// Repositories</span>
    <span class="kd">const</span> <span class="nx">repositoryFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">RepositoryFactoryHttp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createListener</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">transactionHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createTransactionRepository</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">chainHttp</span> <span class="o">=</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createChainRepository</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">transactionService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionService</span><span class="p">(</span><span class="nx">transactionHttp</span><span class="p">,</span> <span class="nx">repositoryFactory</span><span class="p">.</span><span class="nx">createReceiptRepository</span><span class="p">());</span>
    <span class="kd">const</span> <span class="nx">transactionPaginationStreamer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionPaginationStreamer</span><span class="p">(</span><span class="nx">transactionHttp</span><span class="p">);</span>
    <span class="c1">// Replace with exchange account private key</span>
    <span class="kd">const</span> <span class="nx">exchangeAccountPrivateKey</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PRIVATE_KEY</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">exchangeAccount</span> <span class="o">=</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Account</span><span class="p">.</span><span class="nx">createFromPrivateKey</span><span class="p">(</span><span class="nx">exchangeAccountPrivateKey</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">networkType</span><span class="p">);</span>
    <span class="c1">// Replace with destination address from user&#39;s request</span>
    <span class="kd">const</span> <span class="nx">userRawAddress</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RECIPIENT_ADDRESS</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">userAddress</span> <span class="o">=</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Address</span><span class="p">.</span><span class="nx">createFromRawAddress</span><span class="p">(</span><span class="nx">userRawAddress</span><span class="p">);</span>
    <span class="c1">// Replace with the source UUID from user&#39;s request</span>
    <span class="kd">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">UUID</span><span class="p">;</span>
    <span class="c1">// Replace with amount of tokens to transfer from user&#39;s request</span>
    <span class="kd">const</span> <span class="nx">relativeAmount</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AMOUNT</span><span class="p">);</span>
    <span class="c1">// Check that the user has enough funds</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dbService</span><span class="p">.</span><span class="nx">getUserAmount</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">relativeAmount</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;User &#39;</span> <span class="o">+</span> <span class="nx">uuid</span> <span class="o">+</span> <span class="s1">&#39; does not have enough funds.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 1. Create withdrawal transaction</span>
    <span class="kd">const</span> <span class="nx">absoluteAmount</span> <span class="o">=</span> <span class="nx">relativeAmount</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Mosaic</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">,</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">absoluteAmount</span><span class="p">));</span>
    <span class="kd">const</span> <span class="nx">epochAdjustment</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repositoryFactory</span>
        <span class="p">.</span><span class="nx">getEpochAdjustment</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">withdrawalTransaction</span> <span class="o">=</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">epochAdjustment</span><span class="p">),</span> <span class="nx">userAddress</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">],</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">EmptyMessage</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">networkType</span><span class="p">,</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mf">200000</span><span class="p">));</span>
    <span class="c1">// 2. Sign transaction</span>
    <span class="kd">const</span> <span class="nx">signedTransaction</span> <span class="o">=</span> <span class="nx">exchangeAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">withdrawalTransaction</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">networkGenerationHashSeed</span><span class="p">);</span>
    <span class="c1">// 3. Announce transaction and wait for confirmation</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Announcing transaction&#39;</span><span class="p">,</span> <span class="nx">signedTransaction</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionService</span>
        <span class="p">.</span><span class="nx">announce</span><span class="p">(</span><span class="nx">signedTransaction</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Transaction confirmed at height&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_b</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_a</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">_a</span> <span class="o">===</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">:</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">height</span><span class="p">.</span><span class="nx">compact</span><span class="p">())</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">_b</span> <span class="o">!==</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="nx">_b</span> <span class="o">:</span> <span class="mf">0</span><span class="p">);</span>
    <span class="nx">listener</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="topic">
<p class="topic-title first">Multi-signature accounts</p>
<p>When the Exchange Central Wallet is a <a class="reference internal" href="../../concepts/multisig-account.html"><span class="doc">multi-signature account</span></a> announcing the transaction is slightly more complex, as it involves the central wallet and its cosignatories. See the following resources:</p>
<ul class="simple">
<li><a class="reference internal" href="../aggregate/sending-a-multisig-transaction.html"><span class="doc">Sending a multisig transaction</span></a>.</li>
<li><a class="reference internal" href="../aggregate/signing-announced-aggregate-bonded-transactions.html"><span class="doc">Cosigning aggregate bonded transactions</span></a>.</li>
<li><a class="reference internal" href="../aggregate/signing-announced-aggregate-bonded-transactions-automatically.html"><span class="doc">Cosigning aggregate bonded transactions automatically</span></a>.</li>
</ul>
</div>
<p>Once the transaction is confirmed, the next step is to wait for it to be <strong>finalized</strong> to make sure it cannot be reverted. Until then, it should be marked as <strong>pending</strong> and <strong>not acted upon</strong>.</p>
</div>
<div class="section" id="finalization">
<h3>Finalization<a class="headerlink" href="#finalization" title="Permalink to this headline">¶</a></h3>
<p>Waiting for finalization is performed in a manner very similar to how incoming deposits are monitored (see <a class="reference internal" href="#exchange-deposits"><span class="std std-ref">Deposits</span></a> above): The blockchain is polled periodically and all transactions since the last check are processed in a batch, looking for outgoing transfers which have already been finalized.</p>
<p>The following code snippet should be run in a loop every minute, for example, and it will search for finalized withdrawal operations from the Exchange and record them in the Exchange’s database.</p>
<p>This snippet can be run in the same loop as the deposits monitor <a class="reference internal" href="#exchange-deposits"><span class="std std-ref">described above</span></a>.</p>
<div class="example-code container">
<div class="literal-block-wrapper container" id="id8">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/SendWithdrawal.ts">View Code</a></span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-typescript"><div class="highlight"><pre><span></span>    <span class="c1">// Get current chain height and latest finalized block</span>
    <span class="kd">const</span> <span class="p">{</span>
      <span class="nx">height</span>: <span class="kt">currentHeight</span><span class="p">,</span>
      <span class="nx">latestFinalizedBlock</span>: <span class="kt">finalizationBlock</span><span class="p">,</span>
    <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">chainHttp</span><span class="p">.</span><span class="nx">getChainInfo</span><span class="p">().</span><span class="nx">toPromise</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">useFinalization</span>
      <span class="o">?</span> <span class="nx">finalizationBlock.height</span>
      : <span class="kt">currentHeight.subtract</span><span class="p">(</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">requiredConfirmations</span><span class="p">));</span>

    <span class="c1">// Bail out if there have been no new (final) transactions since last check</span>
    <span class="kd">const</span> <span class="nx">lastProcessedHeight</span> <span class="o">=</span> <span class="nx">dbService</span><span class="p">.</span><span class="nx">getLastProcessedHeight</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lastProcessedHeight</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Look for confirmed transactions signed by the central account address,</span>
    <span class="c1">// in the desired block height range.</span>
    <span class="kd">const</span> <span class="nx">searchCriteria</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">group</span>: <span class="kt">TransactionGroup.Confirmed</span><span class="p">,</span>
      <span class="nx">signerPublicKey</span>: <span class="kt">exchangeAccount.publicKey</span><span class="p">,</span>
      <span class="nx">embedded</span>: <span class="kt">true</span><span class="p">,</span>
      <span class="nx">order</span>: <span class="kt">Order.Asc</span><span class="p">,</span>
      <span class="kd">type</span><span class="o">:</span> <span class="p">[</span><span class="nx">TransactionType</span><span class="p">.</span><span class="nx">TRANSFER</span><span class="p">],</span>
      <span class="nx">fromHeight</span>: <span class="kt">lastProcessedHeight.add</span><span class="p">(</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mf">1</span><span class="p">)),</span>
      <span class="nx">toHeight</span>: <span class="kt">maxHeight</span><span class="p">,</span>
    <span class="p">}</span> <span class="kr">as</span> <span class="nx">TransactionSearchCriteria</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionPaginationStreamer</span>
      <span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">searchCriteria</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">toArray</span><span class="p">()</span> <span class="kr">as</span> <span class="nx">any</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
      <span class="s1">&#39;Processing&#39;</span><span class="p">,</span>
      <span class="p">(</span><span class="nx">data</span> <span class="kr">as</span> <span class="nx">TransferTransaction</span><span class="p">[]).</span><span class="nx">length</span><span class="p">,</span>
      <span class="s1">&#39;entries from height&#39;</span><span class="p">,</span>
      <span class="nx">searchCriteria</span><span class="p">.</span><span class="nx">fromHeight</span><span class="o">?</span><span class="p">.</span><span class="nx">compact</span><span class="p">(),</span>
      <span class="s1">&#39;to&#39;</span><span class="p">,</span>
      <span class="nx">searchCriteria</span><span class="p">.</span><span class="nx">toHeight</span><span class="o">?</span><span class="p">.</span><span class="nx">compact</span><span class="p">(),</span>
    <span class="p">);</span>

    <span class="c1">// Record the valid withdrawals in the exchange database</span>
    <span class="p">(</span><span class="nx">data</span> <span class="kr">as</span> <span class="nx">TransferTransaction</span><span class="p">[]).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span>
        <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">AggregateTransactionInfo</span>
          <span class="o">?</span> <span class="nx">transactionInfo.aggregateHash</span>
          : <span class="kt">transactionInfo.hash</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">amount</span> <span class="o">=</span>
        <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">amount</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span> <span class="o">/</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
      <span class="nx">dbService</span><span class="p">.</span><span class="nx">recordWithdrawal</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">transactionHash</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="c1">// Store the last height that has been processed</span>
    <span class="nx">dbService</span><span class="p">.</span><span class="nx">setLastProcessedHeight</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id9">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="https://github.com/symbol/symbol-docs/blob/main/source/resources/examples/typescript/exchanges/SendWithdrawal.js">View Code</a></span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>        <span class="c1">// Get current chain height and latest finalized block</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">latestFinalizedBlock</span><span class="o">:</span> <span class="nx">finalizationBlock</span><span class="p">,</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">chainHttp</span><span class="p">.</span><span class="nx">getChainInfo</span><span class="p">().</span><span class="nx">toPromise</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">useFinalization</span>
            <span class="o">?</span> <span class="nx">finalizationBlock</span><span class="p">.</span><span class="nx">height</span>
            <span class="o">:</span> <span class="nx">currentHeight</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">requiredConfirmations</span><span class="p">));</span>
        <span class="c1">// Bail out if there have been no new (final) transactions since last check</span>
        <span class="kd">const</span> <span class="nx">lastProcessedHeight</span> <span class="o">=</span> <span class="nx">dbService</span><span class="p">.</span><span class="nx">getLastProcessedHeight</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lastProcessedHeight</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="c1">// Look for confirmed transactions signed by the central account address,</span>
        <span class="c1">// in the desired block height range.</span>
        <span class="kd">const</span> <span class="nx">searchCriteria</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">group</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionGroup</span><span class="p">.</span><span class="nx">Confirmed</span><span class="p">,</span>
            <span class="nx">signerPublicKey</span><span class="o">:</span> <span class="nx">exchangeAccount</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span>
            <span class="nx">embedded</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">Order</span><span class="p">.</span><span class="nx">Asc</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="p">[</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">TransactionType</span><span class="p">.</span><span class="nx">TRANSFER</span><span class="p">],</span>
            <span class="nx">fromHeight</span><span class="o">:</span> <span class="nx">lastProcessedHeight</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mf">1</span><span class="p">)),</span>
            <span class="nx">toHeight</span><span class="o">:</span> <span class="nx">maxHeight</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">transactionPaginationStreamer</span>
            <span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">searchCriteria</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">operators_1</span><span class="p">.</span><span class="nx">toArray</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">toPromise</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;entries from height&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_a</span> <span class="o">=</span> <span class="nx">searchCriteria</span><span class="p">.</span><span class="nx">fromHeight</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">_a</span> <span class="o">===</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">:</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">compact</span><span class="p">(),</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_b</span> <span class="o">=</span> <span class="nx">searchCriteria</span><span class="p">.</span><span class="nx">toHeight</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">_b</span> <span class="o">===</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">:</span> <span class="nx">_b</span><span class="p">.</span><span class="nx">compact</span><span class="p">());</span>
        <span class="c1">// Record the valid withdrawals in the exchange database</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">_a</span><span class="p">;</span>
            <span class="kd">const</span> <span class="nx">transactionInfo</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactionInfo</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="kd">const</span> <span class="nx">transactionHash</span> <span class="o">=</span> <span class="nx">transactionInfo</span> <span class="k">instanceof</span> <span class="nx">symbol_sdk_1</span><span class="p">.</span><span class="nx">AggregateTransactionInfo</span>
                <span class="o">?</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">aggregateHash</span>
                <span class="o">:</span> <span class="p">(</span><span class="nx">_a</span> <span class="o">=</span> <span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">_a</span> <span class="o">!==</span> <span class="k">void</span> <span class="mf">0</span> <span class="o">?</span> <span class="nx">_a</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="kd">const</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">mosaics</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">amount</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span> <span class="o">/</span>
                <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tokenDivisibility</span><span class="p">);</span>
            <span class="nx">dbService</span><span class="p">.</span><span class="nx">recordWithdrawal</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">transactionHash</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="c1">// Store the last height that has been processed</span>
        <span class="nx">dbService</span><span class="p">.</span><span class="nx">setLastProcessedHeight</span><span class="p">(</span><span class="nx">maxHeight</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="topic">
<p class="topic-title first">Related links</p>
<ul class="simple">
<li><a class="reference internal" href="../../concepts/transaction.html"><span class="doc">Transaction life-cycle</span></a>.</li>
<li><a class="reference internal" href="../../concepts/fees.html"><span class="doc">Fees reference</span></a>.</li>
<li><a class="reference internal" href="../transfer/sending-a-transfer-transaction.html"><span class="doc">How to announce a transfer transaction programmatically</span></a>.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="further-information">
<h2>Further information<a class="headerlink" href="#further-information" title="Permalink to this headline">¶</a></h2>
<p>Read the following pages for more information:</p>
<ul class="simple">
<li><a class="reference internal" href="../blockchain/global-mosaic-supply.html"><span class="doc">Retrieving the global mosaic supply</span></a>.</li>
</ul>
</div>
</div>

  <div class="section">
  
  
  </div>

            
            <p class="feedback">
                <hr/>
                Did you find what you were looking for?
                <a href="https://github.com/symbol/symbol-docs/issues/new/choose" target="_blank">Give us your feedback.</a>
            </p>
            
        </div>
         

<div class="col-md-2">
    <div class="bs-sidenav secondary" role="complementary">
    
    <div class="edit-github">
    <a href="https://github.com/symbol/symbol-docs/edit/main/source/guides/exchanges/exchange-integration.rst" rel="nofollow"> <i class="fab fa-github"></i> Improve this page</a>
</div>
    <span class="title">On this page</span>
    <ul>
<li><a class="reference internal" href="#">Integrating with an Exchange</a><ul>
<li><a class="reference internal" href="#integration-overview">Integration overview</a><ul>
<li><a class="reference internal" href="#components">Components</a><ul>
<li><a class="reference internal" href="#central-wallet">Central wallet</a></li>
<li><a class="reference internal" href="#cold-wallet">Cold wallet</a></li>
<li><a class="reference internal" href="#unique-user-id">Unique User ID</a></li>
<li><a class="reference internal" href="#exchange-server">Exchange Server</a></li>
<li><a class="reference internal" href="#exchange-database">Exchange Database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-a-node">Running a node</a></li>
<li><a class="reference internal" href="#accounts-setup">Accounts setup</a></li>
<li><a class="reference internal" href="#the-xym-token">The XYM token</a></li>
<li><a class="reference internal" href="#avoiding-rollbacks">Avoiding rollbacks</a><ul>
<li><a class="reference internal" href="#using-finalization">Using Finalization</a></li>
<li><a class="reference internal" href="#using-a-fixed-wait">Using a fixed wait</a></li>
<li><a class="reference internal" href="#deadlines">Deadlines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-example-code">The example code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deposits">Deposits</a><ul>
<li><a class="reference internal" href="#monitoring">Monitoring</a></li>
</ul>
</li>
<li><a class="reference internal" href="#withdrawals">Withdrawals</a><ul>
<li><a class="reference internal" href="#announcing">Announcing</a></li>
<li><a class="reference internal" href="#finalization">Finalization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-information">Further information</a></li>
</ul>
</li>
</ul>

    
    </div>
</div>

 
    </div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
    docsearch({
        apiKey: 'fea87a364e2d51e3729a3a4889f7fe61',
        indexName: 'nemtech',
        inputSelector: '.search-desktop',
        debug: false
    });

    docsearch({
        apiKey: 'fea87a364e2d51e3729a3a4889f7fe61',
        indexName: 'nemtech',
        inputSelector: '.search-mobile',
        debug: false
    });
</script>

  </body>
</html>